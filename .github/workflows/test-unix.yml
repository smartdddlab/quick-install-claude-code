name: Test Unix Scripts

on:
  push:
    branches: [main, master]
    paths:
      - 'install.sh'
      - '.github/workflows/test-unix.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'install.sh'
      - '.github/workflows/test-unix.yml'
  workflow_dispatch:

env:
  # 跳过 SuperClaude 安装（需要认证）
  CLAUDE_SKIP_SUPERCLAUDE: 1
  # 使用中国镜像加速
  CLAUDE_USE_CHINA_MIRROR: 1

jobs:
  # ============================================
  # 核心验证：语法、函数、变量、条件
  # ============================================
  core-validation:
    name: Core Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test Bash syntax
        run: |
          echo "Testing Bash syntax..."
          bash -n install.sh
          echo "Syntax check: PASSED"

      - name: Verify all function definitions exist
        run: |
          echo "Verifying function definitions..."
          script_content=$(cat install.sh)

          required_functions=(
            'command_exists'
            'detect_shell'
            'check_existing_tools'
            'check_dependencies'
            'load_nvm'
            'install_nvm'
            'install_uv'
            'install_node_lts'
            'install_python'
            'configure_npm_mirror'
            'install_claude_code'
            'install_superclaude'
            'configure_shell'
            'main'
          )

          missing=()
          for func in "${required_functions[@]}"; do
            if ! echo "$script_content" | grep -qE "^[[:space:]]*(function[[:space:]]+)?${func}[[:space:]]*\(\)"; then
              missing+=("$func")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing functions: ${missing[*]}"
            exit 1
          fi
          echo "All ${#required_functions[@]} functions verified: PASSED"

      - name: Verify all variable definitions exist
        run: |
          echo "Verifying variable definitions..."
          script_content=$(cat install.sh)

          required_vars=(
            'SCRIPT_VERSION='
            'NVM_VERSION='
            'RED='
            'GREEN='
            'YELLOW='
            'BLUE='
            'NC='
            'SKIP_SUPERCLAUDE='
            'USE_CHINA_MIRROR='
            'DRY_RUN='
            'NVM_DIR='
          )

          missing=()
          for var in "${required_vars[@]}"; do
            if ! echo "$script_content" | grep -qE "^[[:space:]]*${var}"; then
              missing+=("$var")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing variables: ${missing[*]}"
            exit 1
          fi
          echo "All ${#required_vars[@]} variables verified: PASSED"

      - name: Verify conditional logic exists
        run: |
          echo "Verifying conditional logic..."

          # SKIP_SUPERCLAUDE
          if ! grep -qE 'SKIP_SUPERCLAUDE.*==.*1' install.sh; then
            echo "ERROR: SKIP_SUPERCLAUDE logic not found"
            exit 1
          fi
          echo "SKIP_SUPERCLAUDE: PASSED"

          # USE_CHINA_MIRROR
          if ! grep -qE 'USE_CHINA_MIRROR' install.sh; then
            echo "ERROR: USE_CHINA_MIRROR logic not found"
            exit 1
          fi
          echo "USE_CHINA_MIRROR: PASSED"

          # DRY_RUN
          if ! grep -qE 'DRY_RUN.*==.*1' install.sh; then
            echo "ERROR: DRY_RUN logic not found"
            exit 1
          fi
          echo "DRY_RUN: PASSED"

          # npm mirror configuration
          if ! grep -qE 'npmmirror.com' install.sh; then
            echo "ERROR: China mirror configuration not found"
            exit 1
          fi
          echo "China mirror: PASSED"

          echo "All conditional logic verified: PASSED"

      - name: Verify error handling
        run: |
          echo "Verifying error handling..."

          # set -euo pipefail
          head -5 install.sh | grep -q "set -euo pipefail"
          echo "Strict mode: PASSED"

          # log_error with >&2
          if grep -qE 'log_error.*>&2' install.sh; then
            echo "Error redirection: PASSED"
          else
            echo "WARNING: Error redirection may not be proper"
          fi

          # command -v check
          if grep -qE 'command -v' install.sh; then
            echo "Command existence check: PASSED"
          else
            echo "WARNING: Command existence check not found"
          fi

      - name: Verify log functions exist
        run: |
          echo "Verifying log functions..."
          script_content=$(cat install.sh)

          log_funcs=('log_info' 'log_warn' 'log_error' 'log_step' 'log_debug')

          for func in "${log_funcs[@]}"; do
            if ! echo "$script_content" | grep -qE "^[[:space:]]*(function[[:space:]]+)?${func}[[:space:]]*\(\)"; then
              echo "ERROR: Missing log function: $func"
              exit 1
            fi
          done
          echo "All ${#log_funcs[@]} log functions verified: PASSED"

  # ============================================
  # Docker 真实安装测试
  # ============================================
  docker-integration:
    name: Docker Integration (${{ matrix.image }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: alpine:latest
            pkgmgr: apk
          - image: ubuntu:latest
            pkgmgr: apt
          - image: fedora:latest
            pkgmgr: dnf
          - image: debian:latest
            pkgmgr: apt

    container: ${{ matrix.image }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          # 安装基础依赖
          if [ "${{ matrix.pkgmgr }}" = "apk" ]; then
            apk add --no-cache bash curl git ca-certificates sudo
          else
            if [ "${{ matrix.pkgmgr }}" = "dnf" ]; then
              dnf install -y bash curl git ca-certificates sudo
            else
              export DEBIAN_FRONTEND=noninteractive
              apt-get update && apt-get install -y bash curl git ca-certificates sudo
            fi
          fi

      - name: Configure sudo for non-root user
        run: |
          # 确保当前用户有 sudo 权限
          echo "root ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          echo "Defaults:root !requiretty" >> /etc/sudoers

      - name: Run real installation
        id: install
        run: |
          echo "========================================"
          echo "  Running REAL installation on ${{ matrix.image }}"
          echo "========================================"
          echo ""

          # 设置环境变量（跳过 SuperClaude，使用中国镜像）
          export CLAUDE_SKIP_SUPERCLAUDE=1
          export CLAUDE_USE_CHINA_MIRROR=1

          # 记录开始时间
          start_time=$(date +%s)

          # 真实执行安装脚本（不使用 DRY_RUN）
          set +e  # 允许错误继续，以便收集日志
          bash install.sh 2>&1 | tee /tmp/install.log
          exit_code=${PIPESTATUS[0]}
          set -e

          # 记录结束时间
          end_time=$(date +%s)
          duration=$((end_time - start_time))

          echo ""
          echo "========================================"
          echo "  Installation completed in ${duration}s"
          echo "  Exit code: $exit_code"
          echo "========================================"

          # 保存 exit code 供后续步骤使用
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Verify installation results
        run: |
          echo ""
          echo "========================================"
          echo "  Verifying installation results"
          echo "========================================"

          exit_code=$(echo "${{ steps.install.outputs.exit_code }}")
          duration=$(echo "${{ steps.install.outputs.duration }}")

          echo "Exit code: $exit_code"
          echo "Duration: ${duration}s"

          # 检查安装脚本是否成功执行
          if [ "$exit_code" -eq 0 ]; then
            echo "Installation script: PASSED"
          else
            echo "Installation script: FAILED (exit code: $exit_code)"
            echo ""
            echo "Last 50 lines of install log:"
            tail -50 /tmp/install.log
            exit 1
          fi

      - name: Verify tools were installed
        run: |
          echo ""
          echo "========================================"
          echo "  Verifying installed tools"
          echo "========================================"

          # 由于在容器中，可能需要先加载 nvm
          export NVM_DIR="$HOME/.nvm"
          if [ -s "$NVM_DIR/nvm.sh" ]; then
            . "$NVM_DIR/nvm.sh"
          fi

          # 验证 nvm
          if command -v nvm >/dev/null 2>&1 || [ -d "$NVM_DIR" ]; then
            echo "nvm: INSTALLED (or existed before)"
          else
            echo "nvm: NOT FOUND"
          fi

          # 验证 uv
          if command -v uv >/dev/null 2>&1; then
            echo "uv: $(uv --version)"
          else
            echo "uv: NOT FOUND (may need PATH setup)"
          fi

          # 验证 Node.js
          if command -v node >/dev/null 2>&1; then
            echo "node: $(node --version)"
          else
            echo "node: NOT FOUND"
          fi

          # 验证 npm
          if command -v npm >/dev/null 2>&1; then
            echo "npm: $(npm --version)"
          else
            echo "npm: NOT FOUND"
          fi

          # 验证 Python
          if command -v python >/dev/null 2>&1 || command -v python3 >/dev/null 2>&1; then
            python --version 2>/dev/null || python3 --version
            echo "python: FOUND"
          else
            echo "python: NOT FOUND"
          fi

          echo ""
          echo "Tool verification: COMPLETED"

      - name: Verify package manager was detected
        run: |
          echo ""
          echo "========================================"
          echo "  Verifying package manager detection"
          echo "========================================"

          # 检查日志中是否正确检测到包管理器
          if grep -qi "${{ matrix.pkgmgr }}" /tmp/install.log; then
            echo "Package manager (${{ matrix.pkgmgr }}): DETECTED"
          else
            echo "Package manager (${{ matrix.pkgmgr }}: NOT explicitly shown in log (may be ok if deps already existed)"
          fi

      - name: Report results
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "  ${{ matrix.image }} Test: ${{ job.status }}"
          echo "========================================"

  # ============================================
  # macOS 真实安装测试
  # ============================================
  test-macos:
    name: Test on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check existing tools
        id: check-tools
        run: |
          echo "Checking existing tools..."
          echo "nvm_exists=$(command -v nvm 2>/dev/null && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "uv_exists=$(command -v uv 2>/dev/null && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "node_exists=$(command -v node 2>/dev/null && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "claude_exists=$(command -v claude 2>/dev/null && echo true || echo false)" >> $GITHUB_OUTPUT

      - name: Run real installation
        id: install
        run: |
          echo "========================================"
          echo "  Running REAL installation on macOS"
          echo "========================================"
          echo ""

          # 设置环境变量
          export CLAUDE_SKIP_SUPERCLAUDE=1
          export CLAUDE_USE_CHINA_MIRROR=1

          start_time=$(date +%s)

          # 真实执行安装脚本
          set +e
          bash install.sh 2>&1 | tee /tmp/install.log
          exit_code=${PIPESTATUS[0]}
          set -e

          end_time=$(date +%s)
          duration=$((end_time - start_time))

          echo ""
          echo "========================================"
          echo "  Installation completed in ${duration}s"
          echo "  Exit code: $exit_code"
          echo "========================================"

          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
          echo "duration=$duration" >> $GITHUB_OUTPUT

      - name: Verify installation
        run: |
          echo ""
          echo "========================================"
          echo "  Verifying macOS installation"
          echo "========================================"

          exit_code=$(echo "${{ steps.install.outputs.exit_code }}")

          if [ "$exit_code" -eq 0 ]; then
            echo "Installation: PASSED"
          else
            echo "Installation: FAILED"
            tail -30 /tmp/install.log
            exit 1
          fi

          # 验证脚本逻辑存在
          if grep -qE 'npmmirror.com' install.sh; then
            echo "China mirror: CONFIGURED"
          else
            echo "China mirror: NOT CONFIGURED"
          fi

      - name: Report results
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "  macOS Test: ${{ job.status }}"
          echo "========================================"

  # ============================================
  # 汇总报告
  # ============================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [core-validation, docker-integration, test-macos]

    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo ""
          echo "========================================"
          echo "  Test Summary - REAL INSTALLATION"
          echo "========================================"
          echo ""

          all_passed=true

          jobs_info=$(gh run view ${{ github.run_id }} --json jobs -q '.jobs[] | "\(.name)|\(.conclusion)"' 2>/dev/null || echo "")

          failed_jobs=()
          passed_jobs=()

          while IFS='|' read -r name conclusion; do
            [ -z "$name" ] && continue
            echo "  $name: $conclusion"
            if [ "$conclusion" != "success" ]; then
              all_passed=false
              failed_jobs+=("$name")
            else
              passed_jobs+=("$name")
            fi
          done <<< "$jobs_info"

          echo ""
          echo "========================================"
          echo "  Passed: ${#passed_jobs[@]} | Failed: ${#failed_jobs[@]}"
          echo "========================================"

          if [ "$all_passed" = true ]; then
            echo ""
            echo "========================================"
            echo "  ALL REAL INSTALLATION TESTS PASSED!"
            echo "========================================"
            echo ""
            echo "Verified that install.sh works correctly on:"
            echo "  - Alpine Linux (apk)"
            echo "  - Ubuntu (apt)"
            echo "  - Fedora (dnf)"
            echo "  - Debian (apt)"
            echo "  - macOS"
            exit 0
          else
            echo ""
            echo "========================================"
            echo "  SOME TESTS FAILED!"
            echo "========================================"
            for job in "${failed_jobs[@]}"; do
              echo "  - $job"
            done
            exit 1
          fi
