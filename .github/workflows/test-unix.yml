name: Test Unix Scripts

on:
  push:
    branches: [main, master]
    paths:
      - 'install.sh'
      - '.github/workflows/test-unix.yml'
  pull_request:
    branches: [main, master]
    paths:
      - 'install.sh'
      - '.github/workflows/test-unix.yml'
  workflow_dispatch:

jobs:
  # ============================================
  # 基础静态分析测试
  # ============================================
  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test Bash syntax
        run: |
          echo "Testing Bash syntax for install.sh..."
          bash -n install.sh
          echo "Syntax check passed"

      - name: Check strict error handling
        run: |
          echo "Testing strict error handling (set -euo pipefail)..."
          head -10 install.sh | grep -q "set -euo pipefail"
          echo "Strict mode verified"

      - name: Verify script structure
        run: |
          echo "Verifying script structure..."
          # 检查 shebang
          head -1 install.sh | grep -q "^#!/bin/bash"
          # 检查版本定义
          grep -qE "^SCRIPT_VERSION=" install.sh
          grep -qE "^NVM_VERSION=" install.sh
          echo "Script structure verified"

      - name: Verify function definitions (fixed regex)
        run: |
          echo "Verifying function definitions with improved regex..."
          script_content=$(cat install.sh)

          required_functions=(
            'command_exists'
            'detect_shell'
            'check_existing_tools'
            'check_dependencies'
            'load_nvm'
            'install_nvm'
            'install_uv'
            'install_node_lts'
            'install_python'
            'configure_npm_mirror'
            'install_claude_code'
            'install_superclaude'
            'configure_shell'
            'main'
          )

          missing=()
          for func in "${required_functions[@]}"; do
            # 使用扩展正则表达式，支持 function 关键字和空白字符
            if ! echo "$script_content" | grep -qE "^[[:space:]]*(function[[:space:]]+)?${func}[[:space:]]*\(\)"; then
              missing+=("$func")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing functions: ${missing[*]}"
            exit 1
          fi

          echo "All required functions found: ${#required_functions[@]} functions verified"

      - name: Verify variable definitions (not just usage)
        run: |
          echo "Verifying variable definitions..."
          script_content=$(cat install.sh)

          # 检查变量定义（等号赋值），而非简单使用
          required_vars=(
            'SCRIPT_VERSION='
            'NVM_VERSION='
            'SKIP_SUPERCLAUDE='
            'USE_CHINA_MIRROR='
            'DRY_RUN='
            'NVM_DIR='
          )

          missing=()
          for var in "${required_vars[@]}"; do
            # 验证变量定义行（等号前可能有空白）
            if ! echo "$script_content" | grep -qE "^[[:space:]]*${var}"; then
              missing+=("$var")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing variable definitions: ${missing[*]}"
            exit 1
          fi

          echo "All required variables defined: ${#required_vars[@]} variables verified"

      - name: Verify mirror configuration
        run: |
          echo "Verifying mirror configuration..."
          script_content=$(cat install.sh)

          # 验证中国镜像配置
          if echo "$script_content" | grep -q "npmmirror.com"; then
            echo "China mirror (npmmirror.com) found"
          else
            echo "ERROR: China mirror configuration not found"
            exit 1
          fi

          # 验证镜像配置逻辑
          if echo "$script_content" | grep -qE "USE_CHINA_MIRROR.*npmmirror"; then
            echo "Mirror logic verified"
          else
            echo "WARNING: Mirror logic may need review"
          fi

          echo "Mirror configuration verified"

      - name: Verify log functions
        run: |
          echo "Verifying logging functions..."
          script_content=$(cat install.sh)

          log_functions=(
            'log_info'
            'log_warn'
            'log_error'
            'log_step'
            'log_debug'
          )

          missing=()
          for func in "${log_functions[@]}"; do
            if ! echo "$script_content" | grep -qE "^[[:space:]]*(function[[:space:]]+)?${func}[[:space:]]*\(\)"; then
              missing+=("$func")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing log functions: ${missing[*]}"
            exit 1
          fi

          echo "All log functions found: ${#log_functions[@]} functions verified"

      - name: Verify dry run mode implementation
        run: |
          echo "Verifying dry run mode..."
          script_content=$(cat install.sh)

          # 检查 DRY_RUN 在关键函数中的使用
          dry_run_usage=$(grep -c 'DRY_RUN.*==.*1' install.sh || echo "0")

          if [ "$dry_run_usage" -lt 3 ]; then
            echo "WARNING: DRY_RUN usage seems limited ($dry_run_usage occurrences)"
          else
            echo "DRY_RUN usage verified ($dry_run_usage occurrences)"
          fi

          # 验证 DRY_RUN 条件分支
          if grep -qE "DRY_RUN.*1.*log_debug" install.sh; then
            echo "DRY_RUN debug logging verified"
          else
            echo "WARNING: DRY_RUN debug logging not found"
          fi

      - name: Report static analysis results
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "  Static Analysis: PASSED"
          echo "========================================"

  # ============================================
  # Docker 容器集成测试
  # ============================================
  docker-integration-alpine:
    name: Docker Integration (Alpine)
    runs-on: ubuntu-latest
    container: alpine:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install basic dependencies
        run: |
          apk add --no-cache bash curl git ca-certificates

      - name: Test script execution in minimal environment
        run: |
          echo "Testing script in minimal Alpine environment..."
          # 验证脚本能在最小环境中运行
          bash -n install.sh
          echo "Syntax check passed in Alpine"

      - name: Test dry run with minimal deps
        run: |
          echo "Testing dry run with minimal dependencies..."
          # 只保留必要依赖运行
          DRY_RUN=1 bash install.sh 2>&1 | head -100
          echo "Dry run completed in Alpine"

      - name: Test dependency detection
        run: |
          echo "Testing dependency detection logic..."
          # 验证脚本能正确识别缺少的依赖
          # 创建一个模拟环境
          rm -f /usr/bin/curl 2>/dev/null || true
          DRY_RUN=1 bash install.sh 2>&1 | grep -q "缺少基础依赖"
          echo "Dependency detection verified"

      - name: Test package manager detection
        run: |
          echo "Testing package manager detection..."
          # Alpine 使用 apk
          DRY_RUN=1 bash install.sh 2>&1 | grep -q "apk"
          echo "Package manager detection verified (apk)"

      - name: Report Alpine results
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "  Alpine Docker Test: PASSED"
          echo "========================================"

  docker-integration-ubuntu:
    name: Docker Integration (Ubuntu)
    runs-on: ubuntu-latest
    container: ubuntu:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install basic dependencies
        run: |
          export DEBIAN_FRONTEND=noninteractive
          apt-get update
          apt-get install -y bash curl git ca-certificates

      - name: Test script execution in Ubuntu environment
        run: |
          echo "Testing script in Ubuntu environment..."
          bash -n install.sh
          echo "Syntax check passed in Ubuntu"

      - name: Test dry run with apt
        run: |
          echo "Testing dry run with apt package manager..."
          DRY_RUN=1 bash install.sh 2>&1 | head -100
          echo "Dry run completed in Ubuntu"

      - name: Test package manager detection (apt)
        run: |
          echo "Testing apt package manager detection..."
          DRY_RUN=1 bash install.sh 2>&1 | grep -q "apt-get"
          echo "Package manager detection verified (apt-get)"

      - name: Test nvm download URL
        run: |
          echo "Testing nvm download URL accessibility..."
          # 验证 nvm URL 格式正确
          grep -oE "https://raw.githubusercontent.com/nvm-sh/nvm/[v0-9.]+/install.sh" install.sh
          echo "NVM URL format verified"

      - name: Test uv download URL
        run: |
          echo "Testing uv download URL accessibility..."
          # 验证 uv URL 格式正确
          grep -oE "https://astral.sh/uv/install.sh" install.sh
          echo "UV URL format verified"

      - name: Report Ubuntu results
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "  Ubuntu Docker Test: PASSED"
          echo "========================================"

  # ============================================
  # 逻辑流程验证测试
  # ============================================
  logic-validation:
    name: Logic Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Verify function call order in main
        run: |
          echo "Verifying function call order in main()..."

          # 提取 main 函数中的函数调用顺序
          main_section=$(sed -n '/^main() {/,/^}/p' install.sh)

          # 定义期望的调用顺序
          expected_order=(
            "check_dependencies"
            "check_existing_tools"
            "install_nvm"
            "install_uv"
            "install_node_lts"
            "install_python"
            "configure_npm_mirror"
            "install_claude_code"
            "install_superclaude"
            "configure_shell"
          )

          actual_order=$(echo "$main_section" | grep -oE '^\s+(check_dependencies|check_existing_tools|install_nvm|install_uv|install_node_lts|install_python|configure_npm_mirror|install_claude_code|install_superclaude|configure_shell)' | sed 's/[[:space:]]*//g')

          echo "Expected order: ${expected_order[*]}"
          echo "Actual order:"
          echo "$actual_order"

          # 验证关键函数被调用
          for func in "${expected_order[@]}"; do
            if ! echo "$actual_order" | grep -q "^${func}"; then
              echo "ERROR: $func not found in main()"
              exit 1
            fi
          done

          echo "Function call order verified"

      - name: Verify error handling
        run: |
          echo "Verifying error handling patterns..."

          # 检查 set -euo pipefail 存在
          head -5 install.sh | grep -q "set -euo pipefail"

          # 检查 error 日志函数使用 >&2
          if grep -q "log_error.*>&2" install.sh; then
            echo "Error output redirection verified"
          else
            echo "WARNING: Error output may not be properly redirected"
          fi

          # 检查命令存在性检查
          if grep -q "command -v" install.sh; then
            echo "Command existence check verified"
          else
            echo "WARNING: Command existence check not found"
          fi

          echo "Error handling verified"

      - name: Verify conditional logic
        run: |
          echo "Verifying conditional logic..."

          # 验证 SKIP_SUPERCLAUDE 条件
          if grep -qE 'SKIP_SUPERCLAUDE.*==.*1' install.sh; then
            echo "SKIP_SUPERCLAUDE logic verified"
          else
            echo "ERROR: SKIP_SUPERCLAUDE logic not found"
            exit 1
          fi

          # 验证 USE_CHINA_MIRROR 条件
          if grep -qE 'USE_CHINA_MIRROR.*!=.*1' install.sh; then
            echo "USE_CHINA_MIRROR logic verified"
          else
            echo "ERROR: USE_CHINA_MIRROR logic not found"
            exit 1
          fi

          # 验证 DRY_RUN 条件
          if grep -qE 'DRY_RUN.*==.*1' install.sh; then
            echo "DRY_RUN logic verified"
          else
            echo "ERROR: DRY_RUN logic not found"
            exit 1
          fi

          echo "Conditional logic verified"

      - name: Verify URL accessibility
        run: |
          echo "Verifying external URLs..."

          # 提取所有外部 URL
          urls=$(grep -oE 'https://[^[:space:]]+' install.sh | sort -u)

          for url in $urls; do
            # 跳过文件 URL 和数据 URL
            if echo "$url" | grep -qE '(raw.githubusercontent.com|astral.sh|npmmirror.com)'; then
              echo "Checking: $url"
              # 验证 URL 格式正确（不实际下载）
              if echo "$url" | grep -qE '^https://'; then
                echo "  URL format OK"
              else
                echo "  ERROR: Invalid URL format"
                exit 1
              fi
            fi
          done

          echo "URL verification completed"

      - name: Report logic validation results
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "  Logic Validation: PASSED"
          echo "========================================"

  # ============================================
  # Linux (原生) 测试
  # ============================================
  test-linux:
    name: Test on Linux
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test Bash syntax
        run: |
          echo "Testing Bash syntax for install.sh..."
          bash -n install.sh
          echo "Syntax check passed"

      - name: Test dry run mode
        run: |
          echo "Running install.sh in DRY_RUN mode..."
          DRY_RUN=1 bash install.sh 2>&1 | head -100
          echo "Dry run mode test passed"

      - name: Verify all functions exist
        run: |
          echo "Verifying all functions are defined..."
          script_content=$(cat install.sh)

          required_functions=(
            'command_exists'
            'detect_shell'
            'check_existing_tools'
            'check_dependencies'
            'load_nvm'
            'install_nvm'
            'install_uv'
            'install_node_lts'
            'install_python'
            'configure_npm_mirror'
            'install_claude_code'
            'install_superclaude'
            'configure_shell'
            'main'
          )

          missing=()
          for func in "${required_functions[@]}"; do
            if ! echo "$script_content" | grep -qE "^[[:space:]]*(function[[:space:]]+)?${func}[[:space:]]*\(\)"; then
              missing+=("$func")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing functions: ${missing[*]}"
            exit 1
          fi

          echo "All required functions found: ${#required_functions[@]} functions verified"

      - name: Verify all variables defined
        run: |
          echo "Verifying all variables are defined..."
          script_content=$(cat install.sh)

          required_vars=(
            'SCRIPT_VERSION='
            'NVM_VERSION='
            'SKIP_SUPERCLAUDE='
            'USE_CHINA_MIRROR='
            'DRY_RUN='
            'NVM_DIR='
          )

          missing=()
          for var in "${required_vars[@]}"; do
            if ! echo "$script_content" | grep -qE "^[[:space:]]*${var}"; then
              missing+=("$var")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing variable definitions: ${missing[*]}"
            exit 1
          fi

          echo "All required variables defined: ${#required_vars[@]} variables verified"

      - name: Verify color output functions
        run: |
          echo "Verifying color output definitions..."
          script_content=$(cat install.sh)

          # 检查颜色变量定义
          colors=(
            'RED='
            'GREEN='
            'YELLOW='
            'BLUE='
            'NC='
          )

          missing=()
          for color in "${colors[@]}"; do
            if ! echo "$script_content" | grep -qE "^${color}"; then
              missing+=("$color")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing color definitions: ${missing[*]}"
            exit 1
          fi

          echo "All color definitions found: ${#colors[@]} colors verified"

      - name: Report Linux test results
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "  Linux Native Test: PASSED"
          echo "========================================"

  # ============================================
  # macOS 测试
  # ============================================
  test-macos:
    name: Test on macOS
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test Bash syntax
        run: |
          echo "Testing Bash syntax for install.sh..."
          bash -n install.sh
          echo "Syntax check passed"

      - name: Test dry run mode
        run: |
          echo "Running install.sh in DRY_RUN mode..."
          DRY_RUN=1 bash install.sh 2>&1 | head -100
          echo "Dry run mode test passed"

      - name: Verify all functions exist (same as Linux)
        run: |
          echo "Verifying all functions are defined..."
          script_content=$(cat install.sh)

          required_functions=(
            'command_exists'
            'detect_shell'
            'check_existing_tools'
            'check_dependencies'
            'load_nvm'
            'install_nvm'
            'install_uv'
            'install_node_lts'
            'install_python'
            'configure_npm_mirror'
            'install_claude_code'
            'install_superclaude'
            'configure_shell'
            'main'
          )

          missing=()
          for func in "${required_functions[@]}"; do
            if ! echo "$script_content" | grep -qE "^[[:space:]]*(function[[:space:]]+)?${func}[[:space:]]*\(\)"; then
              missing+=("$func")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing functions: ${missing[*]}"
            exit 1
          fi

          echo "All required functions found: ${#required_functions[@]} functions verified"

      - name: Verify all variables defined (same as Linux)
        run: |
          echo "Verifying all variables are defined..."
          script_content=$(cat install.sh)

          required_vars=(
            'SCRIPT_VERSION='
            'NVM_VERSION='
            'SKIP_SUPERCLAUDE='
            'USE_CHINA_MIRROR='
            'DRY_RUN='
            'NVM_DIR='
          )

          missing=()
          for var in "${required_vars[@]}"; do
            if ! echo "$script_content" | grep -qE "^[[:space:]]*${var}"; then
              missing+=("$var")
            fi
          done

          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing variable definitions: ${missing[*]}"
            exit 1
          fi

          echo "All required variables defined: ${#required_vars[@]} variables verified"

      - name: Verify mirror configuration
        run: |
          echo "Verifying mirror configuration..."
          script_content=$(cat install.sh)

          if echo "$script_content" | grep -q "npmmirror.com"; then
            echo "China mirror (npmmirror.com) found"
          else
            echo "ERROR: China mirror configuration not found"
            exit 1
          fi

          echo "Mirror configuration verified"

      - name: Report macOS test results
        if: always()
        run: |
          echo ""
          echo "========================================"
          echo "  macOS Test: PASSED"
          echo "========================================"

  # ============================================
  # 汇总报告
  # ============================================
  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [static-analysis, docker-integration-alpine, docker-integration-ubuntu, logic-validation, test-linux, test-macos]

    if: always()
    steps:
      - name: Check all jobs status
        run: |
          echo ""
          echo "========================================"
          echo "  Test Summary"
          echo "========================================"
          echo ""

          jobs=("static-analysis" "docker-integration-alpine" "docker-integration-ubuntu" "logic-validation" "test-linux" "test-macos")
          all_passed=true

          for job in "${jobs[@]}"; do
            status=$(gh api repos/${{ github.repository }}/actions/runs/${{ github.run_id }}/jobs --paginate -q ".jobs[] | select(.name == \"$job\") | .conclusion" 2>/dev/null || echo "skipped")
            echo "  $job: $status"
            if [ "$status" != "success" ]; then
              all_passed=false
            fi
          done

          echo ""
          if [ "$all_passed" = true ]; then
            echo "========================================"
            echo "  ALL TESTS PASSED!"
            echo "========================================"
            exit 0
          else
            echo "========================================"
            echo "  SOME TESTS FAILED!"
            echo "========================================"
            exit 1
          fi
